# Direct Proxies API Shim for Node

This module contains a minimal wrapper around the reference shim implementation of the new Direct Proxies API that replaces the old Harmony Proxy proposal as of December 2011. It loads the shim unchanged but then wraps the Proxy, Proxy.create, and Proxy.createFunction functions in order to capture references to proxies and their targets. It then wrap Object.getOwnPropertyDescriptor and forges descriptors for lookups on target objects, presenting them as always
configurable. This preempts incompatabilities with the new API and the current implementation in V8 that would
cause errors to be thrown every time there's a non-configurable property.

The reference Dirext Proxy shim originates here and is included unmodified in this module: [es-lab DirectProxies.js](http://code.google.com/p/es-lab/source/browse/trunk/src/proxies/DirectProxies.js)

The reference test originates here and is only modified to load the shim using node's module system and console.log: [es-lab testDirectProxies.js](http://code.google.com/p/es-lab/source/browse/trunk/src/proxies/testDirectProxies.js)

The official documentation and API is here: [ES Wiki - Direct Proxies](http://wiki.ecmascript.org/doku.php?id=harmony:direct_proxies)

This is mainly thanks to the hard work of [Tom Van Cutsem](https://github.com/tvcutsem) in both producing the API to begin with along with a shim to provide the functionality on top of existing Proxy functionality.


# Usage

This work in both node and in the browser (Chrome since you don't need to shim the DirectProxy shim in Firefox). In Node you can specify vm context objects to shim and in browsers you can specify windows like iframes. By default it'll patch the context its running in.

It can be run asynchronously or synchronously in both the browser and in the browser. This isn't exactly something you'd be using in production anyway...

```javascript

// if in node
var directProxies = require('direct-proxies');
// initialize on context
directProxies.shim();               // shims the `global` context
directProxies.shim(contextObject);  // shims an existing context object created using vm.createContext()
directProxies.shim(function(){ //ready });  // asynchronously load the shim

// in the browser you'll want to uncomment the lines at the top of the index.js and do the shimming in
// the anonymous context. You simply run `shim()` to patch the current window.


// `Proxy` itself is now the creator for all proxies
var proxy = Proxy(target, handler);


// all traps now have their first parameter as `target` referencing the real object
{ getOwnPropertyDescriptor: function(target,name) }


// new global `Reflect` contains default traps
global.Reflect:
 { getOwnPropertyDescriptor,  // non-own `getProperty[Names|Descriptor]` gone
   getOwnPropertyNames,
   defineProperty,
   deleteProperty,            // renamed from `delete`
   freeze,                    // freeze/seal/preventExtensions separated
   seal,
   preventExtensions,
   has,
   hasOwn,
   get,
   set,
   enumerate,
   iterate,
   keys,
   apply,                     // apply/new are now traps on the handler
   construct }


// for virtualized objects you can use this for your handler.prototype
// it implements some handlers but requires the others, like old fundamental traps
global.Reflect.VirtualHandler.prototype
 abstract { getOwnPropertyDescriptor,
 abstract   getOwnPropertyNames,
 abstract   defineProperty,
 abstract   deleteProperty,
            freeze,
            seal,
 abstract   preventExtensions,
            has,
            hasOwn,
            get,
            set,
            enumerate,
            iterate,
            keys,
 abstract   apply,
            construct }
```


# Compatability

The current stable Node.js branch, 0.6.x, uses a version of V8 with bugs that makes it incompatible with this shim. Node's master branch (0.7.x unstable) uses a new V8 which resolves the issue and is **required** to make this work.

<<<<<<< HEAD
If you are using Node 0.7.x and are still getting "Illegal Access" errors I have a pull request that solves this issue (along with greatly improving util.inspect) here https://github.com/joyent/node/pull/2360. It should be integrated into Node's master branch soon and hopefully will be available along with the fixed V8 implementation for Node 0.8.
=======
If you are using Node >0.6.6 and are still getting "Illegal Access" errors see this:
https://github.com/joyent/node/pull/2109

# Trap Reference

```javascript
var traps = {
  getOwnPropertyDescriptor : ['target', 'name']                     , //->  desc | undefined
  getOwnPropertyNames      : ['target']                             , //->  [ string ]
  defineProperty           : ['target', 'name', 'descriptor']       , //->  boolean

  preventExtensions        : ['target']                              , //->  boolean
  freeze                   : ['target']                              , //->  boolean
  seal                     : ['target']                              , //->  boolean

  delete                   : ['target', 'name']                      , //->  boolean
  hasOwn                   : ['target', 'name']                      , //->  boolean
  has                      : ['target', 'name']                      , //->  boolean
  get                      : ['target', 'name', 'receiver']          , //->  any
  set                      : ['target', 'name', 'val', 'receiver']   , //->  boolean

  enumerate                : ['target']                               , //->  [ string ]
  iterate                  : ['target']                               , //->  iterator `next` fn
  keys                     : ['target']                               , //->  [ string ]

  apply                    : ['target', 'receiver', 'args']           , //->  any
  new                      : ['target', 'args']                       , //->  any
};
```
>>>>>>> Add trap reference to readme, remove .js extension from require in test file.
